From 2dd2b214e0c646cbb24bdd0ca7fba95d5d93514f Mon Sep 17 00:00:00 2001
Message-Id: <2dd2b214e0c646cbb24bdd0ca7fba95d5d93514f.1524081065.git.Jim.Somerville@windriver.com>
In-Reply-To: <8d084dcc717666af0283e4ddeefaba7e331d879a.1524081065.git.Jim.Somerville@windriver.com>
References: <8d084dcc717666af0283e4ddeefaba7e331d879a.1524081065.git.Jim.Somerville@windriver.com>
From: Scott Little <scott.little@windriver.com>
Date: Tue, 9 May 2017 13:00:13 -0400
Subject: [PATCH 15/39] tis build unsigned package

Signed-off-by: Jim Somerville <Jim.Somerville@windriver.com>
---
 SPECS/kernel-rt.spec | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/SPECS/kernel-rt.spec b/SPECS/kernel-rt.spec
index 8ee6191..c8faf30 100644
--- a/SPECS/kernel-rt.spec
+++ b/SPECS/kernel-rt.spec
@@ -25,7 +25,7 @@ Summary: The Linux Realtime kernel
 
 # If we want to sign the kernel and modules, do_sign should be 1.
 # To speed up builds (don't sign) use 0.
-%global do_sign 0
+%global do_sign 1
 
 # conditional with/without variables
 # Note that the logic here is inverted; a  bcond_without implies
@@ -692,6 +692,13 @@ the kernel source.
 
 %endif # with_tools
 
+%if %{do_sign}
+%package unsigned
+Summary: Unsigned build of the Linux kernel
+%description unsigned
+Contains an unsigned version of the Linux kernel
+%endif # do_sign
+
 %prep
 ## ApplyPatch routine
 patch_command='patch -p1 -F1 -s'
@@ -936,6 +943,8 @@ BuildKernel() {
     fi
 # EFI SecureBoot signing, x86_64-only
 %if %{do_sign}
+    cp $KernelImage vmlinuz.unsigned
+    $CopyKernel vmlinuz.unsigned $RPM_BUILD_ROOT/%{image_install_path}/vmlinuz.unsigned
 %ifarch x86_64
     %pesign -s -i $KernelImage -o $KernelImage.signed -a %{SOURCE37} -c %{SOURCE37} -n %{pesign_name}
     mv $KernelImage.signed $KernelImage
@@ -1707,6 +1716,11 @@ fi
 %kernel_variant_files %{buildvanilla} vanilla
 %endif
 
+%if %{do_sign}
+%files unsigned
+/boot/vmlinuz.unsigned
+%endif # do_sign
+
 %changelog
 * Fri Feb 23 2018 Clark Williams <williams@redhat.com> [3.10.0-693.21.1.rt56.639.el7]
 - [rt] Update source tree to match RHEL 7.4 tree [1537671 1462329]
-- 
1.8.3.1

